# Android Native Authentication Setup Guide

This guide details exactly how to implement and configure a fully native Google Authentication flow for an Android app built with Capacitor, integrating directly with Supabase.

This was initially set up in this project using the `@capacitor-firebase/authentication` package.

## 1. Prerequisites

- A [Capacitor](https://capacitorjs.com/) App configured for Android (`npx cap add android`)
- A [Supabase](https://supabase.com/) project with Google Provider enabled in Auth Settings.
  - **Note:** You DO NOT need to add the Android Client ID or SHA-1 fingerprint into the Supabase Dashboard. Supabase only needs to know about your Web Client ID. It will verify the native ID token using that Web Client ID.
  - **Note:** The "Callback URL" (redirect URL) configured in Supabase (e.g., `localhost:3000`) does not affect the native Android flow. This is because the native Capacitor flow bypasses the browser redirect entirely and instead uses the Google Sign-In SDK to obtain an ID token, which is then sent directly to Supabase's API.
- A **Web Client ID** generated by Google Cloud Platform (usually automatically created via Supabase setup).

## 2. Installation

Install the Capacitor Firebase Authentication plugin (specifically chosen because it perfectly supports native Google Authentication on newer Capacitor v8 versions without the need for complex Firebase configurations).

```bash
npm install @capacitor-firebase/authentication
npx cap sync android
```

## 3. Google Cloud Console Configuration

This is the most critical part for Native apps. You need **two** Client IDs functioning together.

### Step A: Locate your Web Client ID
Find the "Web application" Client ID that your web app and Supabase currently use in your Google Cloud Console.

### Step B: Inject into Android
Open `android/app/src/main/res/values/strings.xml` and add your Web Client ID under the name `server_client_id`:

```xml
<resources>
    <!-- Your existing config -->
    <string name="server_client_id">YOUR_WEB_CLIENT_ID_HERE</string>
</resources>
```

### Step C: Create your Android Client ID
Native Android Google sign-in strictly requires an **Android OAuth Client ID**.

1. In Google Cloud Console, navigate to **APIs & Services > Credentials**.
2. Click **Create Credentials > OAuth client ID**.
3. Application type: **Android**.
4. Set the **Package name** (found in your `capacitor.config.ts`, e.g., `com.costpilot.app`).
5. Provide the **SHA-1 certificate fingerprint**.
    - For local development (Emulator/USB debugging), use your Android Debug Keystore:
      ```bash
      keytool -keystore ~/.android/debug.keystore -list -v -storepass android
      ```
      *(Copy the `SHA1` value under Certificate fingerprints)*
    - For production (Play Store), use your release keystore.

> **Why two Client IDs?** The Android app uses the Android Client ID (via package name + SHA-1) to authorize the app on the device. It then requests an ID Token *on behalf of* the Web Client ID (`server_client_id`). Since Supabase only knows about the Web Client ID, this token perfectly validates on the server.

## 4. Code Implementation

Modify your authentication logic to implement platform detection (`Capacitor.isNativePlatform()`).

On Android, we trigger the native bottom-sheet Google picker instead of redirecting the user out to a web browser. We then take the resulting `idToken` and pass it to Supabase via `signInWithIdToken()`.

```typescript
import { supabase } from '../services/supabaseClient';
import { Capacitor } from '@capacitor/core';
import { FirebaseAuthentication } from '@capacitor-firebase/authentication';

const signIn = async () => {
    try {
        if (Capacitor.isNativePlatform()) {
            // Android Native Flow
            const result = await FirebaseAuthentication.signInWithGoogle();
            const idToken = result.credential?.idToken;

            if (!idToken) throw new Error('No ID token received');

            // Pass the native Google token directly to Supabase
            const { error } = await supabase.auth.signInWithIdToken({
                provider: 'google',
                token: idToken,
            });

            if (error) throw error;
        } else {
            // Standard Web Flow
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: { queryParams: { access_type: 'offline', prompt: 'consent' } },
            });
            if (error) throw error;
        }
    } catch (error) {
        console.error('Sign in error:', error);
    }
};

const logOut = async () => {
    try {
        // Sign out of the native plugin so the picker doesn't auto-select next time
        if (Capacitor.isNativePlatform()) {
            await FirebaseAuthentication.signOut();
        }
        await supabase.auth.signOut();
    } catch (error) {
        console.error('Sign out error:', error);
    }
};
```

## 5. Build and Test

```bash
npm run build
npx cap sync android
npx cap open android
```

Run inside the Android emulator or device from Android Studio.

## Troubleshooting

- **`DEVELOPER_ERROR` / `10: `**:
    - The `server_client_id` in `strings.xml` is missing or incorrect (ensure it is the *Web* Client ID, not the Android one).
    - Your debug SHA-1 fingerprint hasn't been added to your Android OAuth Client in the Google Cloud Console.
    - Double check your package name matches exactly.
